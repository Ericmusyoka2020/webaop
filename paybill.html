<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title></title>
<style>
* { box-sizing: border-box; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
  background: #121212;
  color: #e0e0e0;
  margin: 0;
  padding: 20px;
  min-height: 100vh;
}
.container {
  max-width: 450px;
  background: #1e1e1e;
  margin: 0 auto;
  padding: 25px;
  border-radius: 12px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.4);
}
.step-label {
  display: none;
  margin-top: 15px;
  font-weight: 600;
  color: #b0b0b0;
  text-align: center;
}
.step-label.active { display: block; }
input, button {
  width: 100%;
  padding: 12px;
  margin-top: 8px;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  display: none;
}
input.active, button.active { display: block; }
input {
  background: #2a2a2a;
  color: #fff;
  border: 1px solid #404040;
}
input::placeholder { color: #888; }
input:focus {
  outline: none;
  border-color: #4caf50;
  box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
}
button {
  background: linear-gradient(135deg, #080808, #0d0e0d);
  color: white;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
}
button:hover {
  background: linear-gradient(135deg, #45a049, #388e3c);
  transform: translateY(-1px);
}
button:active { transform: translateY(0); }
pre {
  background: #252525;
  padding: 15px;
  border-radius: 8px;
  margin-top: 15px;
  white-space: pre-wrap;
  font-size: 14px;
}
@media (max-width: 480px) {
  body { padding: 15px; }
  .container { padding: 20px; margin: 10px auto; border-radius: 16px; }
  input, button { padding: 14px; font-size: 17px; }
}
.hint {
  color: #888;
  font-size: 13px;
  margin-top: 4px;
  text-align: center;
  display: none;
}
.hint.active { display: block; }
</style>
</head>
<body>
<div class="container">
  <!-- Step 1: Till No -->
  <div class="step-label active" id="phoneLabel">Enter business no.</div>
  <input type="text" id="phone" class="active" placeholder="">
  <button id="phoneOkBtn" class="active">OK</button>

  <!-- Step 2: Amount -->
  <div class="step-label" id="amountLabel">Enter Amount</div>
  <input type="number" id="amount" placeholder="">
  <button id="amountOkBtn">OK</button>

  <!-- Step 3: Account Number -->
  <div class="step-label" id="accountLabel">Enter Account Number</div>
  <input type="text" id="account" placeholder="">
  <button id="accountOkBtn">OK</button>

  <!-- Step 4: Name (always shown for review/edit) -->
  <div class="step-label" id="nameLabel">Recipient Name</div>
  <input type="text" id="name" placeholder="Full name">
  <div class="hint" id="nameHint">Edit if incorrect</div>
  <button id="nameOkBtn">OK</button>

  <!-- Step 5: Send -->
  <button id="sendBtn">Send</button>

  <!-- Output -->
  <pre id="output"></pre>
</div>

<script>
const API = "https://mpesab.vercel.app";
const STORAGE_KEY = "tillToNameMap";

const phone   = document.getElementById("phone");
const amount  = document.getElementById("amount");
const account = document.getElementById("account");
const name    = document.getElementById("name");
const nameHint = document.getElementById("nameHint");

const output = document.getElementById("output");

const phoneOkBtn   = document.getElementById("phoneOkBtn");
const amountOkBtn  = document.getElementById("amountOkBtn");
const accountOkBtn = document.getElementById("accountOkBtn");
const nameOkBtn    = document.getElementById("nameOkBtn");
const sendBtn      = document.getElementById("sendBtn");

// Load saved till → name mappings
let tillToName = {};
try {
  const saved = localStorage.getItem(STORAGE_KEY);
  if (saved) tillToName = JSON.parse(saved);
} catch (e) {}

function saveTillName(till, fullName) {
  if (!till || !fullName.trim()) return;
  tillToName[till.trim()] = fullName.trim();
  localStorage.setItem(STORAGE_KEY, JSON.stringify(tillToName));
}

function getSavedName(till) {
  return tillToName[till.trim()] || "";
}

function hideAll(){
  document.querySelectorAll(".step-label").forEach(e=>e.classList.remove("active"));
  document.querySelectorAll("input").forEach(e=>e.classList.remove("active"));
  document.querySelectorAll("button").forEach(e=>e.classList.remove("active"));
  document.querySelectorAll(".hint").forEach(e=>e.classList.remove("active"));
}

function showPhone(){
  hideAll();
  document.getElementById("phoneLabel").classList.add("active");
  phone.classList.add("active");
  phoneOkBtn.classList.add("active");
}

function showAmount(){
  hideAll();
  document.getElementById("amountLabel").classList.add("active");
  amount.classList.add("active");
  amountOkBtn.classList.add("active");
}

function showAccount(){
  hideAll();
  document.getElementById("accountLabel").classList.add("active");
  account.classList.add("active");
  accountOkBtn.classList.add("active");
}

function showName(){
  hideAll();
  document.getElementById("nameLabel").classList.add("active");
  name.classList.add("active");
  nameOkBtn.classList.add("active");
  nameHint.classList.add("active"); // show edit hint
}

function showSend(){
  hideAll();
  sendBtn.classList.add("active");
}

function cost(a){
  return 0; // simplified — all 0 as before
}

function token(){
  return "UAJ" + Math.random().toString(36).substring(2,9).toUpperCase();
}

function getDateTime(){
  const d = new Date();
  const dateStr = `${d.getDate().toString().padStart(2,'0')}/${(d.getMonth()+1).toString().padStart(2,'0')}/${String(d.getFullYear()).slice(-2)}`;
  const timeStr = d.toLocaleTimeString('en-US', {
    hour: 'numeric',
    minute: '2-digit',
    hour12: true
  }).replace(',', '');
  return { date: dateStr, time: timeStr };
}

/* ===== FLOW ===== */
showPhone();

phoneOkBtn.onclick = async () => {
  const till = phone.value.trim();
  if (!till) return alert("Enter till number");

  // Try to pre-fill name
  let prefilled = getSavedName(till);
  if (!prefilled) {
    try {
      const r = await fetch(`${API}/lookup/${till}`);
      const d = await r.json();
      if (d.found && d.name) {
        prefilled = d.name;
        saveTillName(till, prefilled);
      }
    } catch {}
  }

  name.value = prefilled;
  showAmount();
};

amountOkBtn.onclick = () => {
  if (+amount.value <= 0) return alert("Invalid amount");
  showAccount();
};

accountOkBtn.onclick = () => {
  if (!account.value.trim()) return alert("Enter account number");
  showName(); // always go to name for review
};

nameOkBtn.onclick = () => {
  const fullName = name.value.trim();
  if (!fullName) return alert("Enter full name");

  // Save/update the name for this till
  saveTillName(phone.value.trim(), fullName);

  showSend();
};

sendBtn.onclick = async () => {
  const a = +amount.value;
  const c = cost(a);
  const t = token();
  const { date, time } = getDateTime();

  const msg =
`${t} Confirmed. Ksh${a.toFixed(2)} transferred to ${name.value} for account ${account.value} on ${date} at ${time}. Merchant Account Balance is Ksh${(Math.random()*2000+500).toFixed(2)}.`;

  output.textContent = msg;

  try {
    await fetch(`${API}/send`, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({
        phone: phone.value,
        name: name.value,
        amount: a,
        cost: c,
        message: msg,
        token: t
      })
    });
  } catch {}

  // Reset
  phone.value = "";
  amount.value = "";
  account.value = "";
  name.value = "";
  output.textContent = "";

  showPhone();
};
</script>
</body>
</html>
