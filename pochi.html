

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title></title>
<style>
* { box-sizing: border-box; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
  background: #121212;
  color: #e0e0e0;
  margin: 0;
  padding: 20px;
  min-height: 100vh;
}
.container {
  max-width: 450px;
  width: 100%;
  background: #615f5f;
  margin: 0 auto;
  padding: 25px;
  border-radius: 12px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.4);
}
.step-label {
  display: none !important;
  margin-top: 15px;
  font-weight: 600;
  color:#2a2a2a ;
  text-align: center;
  padding: 8px 0;
}
.step-label.active {
  display: block !important;
}
input, button {
  width: 100%;
  padding: 12px 16px;
  margin-top: 8px;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  display: none;
}
input.active, button.active {
  display: block;
}
input {
  background: #2a2a2a;
  color: #e0e0e0;
  border: 1px solid #2a2a2a;
}
input::placeholder {
  color: #2a2a2a;
}
input:focus {
  outline: none;
  border-color: #2a2a2a;
  box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
}
button {
  background: linear-gradient(135deg,#2a2a2a ,#2a2a2a );
  color: white;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
}
button:hover {
  background: linear-gradient(135deg, #2a2a2a,#2a2a2a );
  transform: translateY(-1px);
}
button:active {
  transform: translateY(0);
}
pre {
  background: #2a2a2a;
  color: #e8eaf6;
  padding: 16px;
  border-radius: 8px;
  margin-top: 15px;
  white-space: pre-wrap;
  font-size: 14px;
  line-height: 1.5;
  border-left: 4px solid#2a2a2a ;
  min-height: 40px;
}
/* Style for error text */
.error-text {
  color: #ff5252;
  border-left-color: #ff5252;
}
.option-info {
  display: none;
  margin-top: 20px;
  padding: 12px 16px;
  background: #2a2a2a;
  border: 2px solid#2a2a2a ;
  border-radius: 8px;
  font-weight: 500;
}
.option-info.active {
  display: block;
}
@media (max-width: 480px) {
  body { padding: 15px; }
  .container { padding: 20px; margin: 10px auto; border-radius: 16px; }
  input, button { padding: 14px 16px; font-size: 17px; }
}
</style>
</head>
<body>
<div class="container">
  <div class="step-label active" id="phoneLabel">Enter phone no.</div>
  <input type="text" id="phone" class="active">
  <button id="phoneOkBtn" class="active">OK</button>

  <div class="step-label" id="amountLabel">Enter Amount</div>
  <input type="number" id="amount" placeholder=" ">
  <button id="amountOkBtn">OK</button>

  <div class="step-label" id="nameLabel">Enter Full Name</div>
  <input type="text" id="name" placeholder="Enter full name">
  <button id="nameOkBtn">OK</button>

  <div class="option-info active" id="optionInfo">
    Format: Sendmoney (includes ony name as saf shows)
  </div>

  <button id="sendBtn">Send Message</button>
  <pre id="output"></pre>
</div>

<script>
const API = "https://mpesab.vercel.app";

const elements = {
  phone: { input: document.getElementById("phone"), btn: document.getElementById("phoneOkBtn"), label: document.getElementById("phoneLabel") },
  amount: { input: document.getElementById("amount"), btn: document.getElementById("amountOkBtn"), label: document.getElementById("amountLabel") },
  name:   { input: document.getElementById("name"),   btn: document.getElementById("nameOkBtn"),   label: document.getElementById("nameLabel") },
  optionInfo: document.getElementById("optionInfo"),
  send: document.getElementById("sendBtn"),
  output: document.getElementById("output")
};

// Helper function to show errors/messages in the UI instead of alerts
function showStatus(msg, isError = false) {
  elements.output.textContent = msg;
  if (isError) {
    elements.output.classList.add('error-text');
  } else {
    elements.output.classList.remove('error-text');
  }
}

function calculateCost(amount) {
  if(amount >= 1   && amount <= 100)    return 0;
  if(amount >= 101 && amount <= 500)    return 7;
  if(amount >= 501 && amount <= 1000)   return 13;
  if(amount >= 1001 && amount <= 20000) return 50;
  if(amount >= 20001 && amount <= 35000) return 108;
  if(amount >= 35001 && amount <= 50000) return 150;
  if(amount >= 50001 && amount <= 250000) return 108;
  return 113;
}

function generateUAToken() {
  const now = new Date();
  const start = new Date(now.getFullYear(), 0, 0);
  const diff = now - start;
  const oneDay = 1000 * 60 * 60 * 24;
  const dayOfYear = Math.floor(diff / oneDay);
  const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
  let index = (dayOfYear - 10) % 26;
  if (index < 0) index += 26; 
  const thirdLetter = alphabet[index]; 
  const randomSuffix = Math.random().toString(36).substring(2, 9).toUpperCase();
  return "UA" + thirdLetter + randomSuffix;
}

function randomBalance() { 
  return (Math.random() * 5000 + 100).toFixed(2);
}

function formatDateTime() {
  const d = new Date();
  return `${d.getDate()}/${d.getMonth()+1}/${String(d.getFullYear()).slice(-2)} at `
       + d.toLocaleTimeString([], {hour:'numeric',minute:'2-digit'});
}

function showStep(step) {
  // Clear status message when moving steps
  showStatus("");
  
  document.querySelectorAll('.step-label').forEach(label => label.classList.remove('active'));
  Object.values(elements).forEach(el => {
    if (el?.input) el.input.classList.remove('active');
    if (el?.btn)   el.btn.classList.remove('active');
    if (el === elements.optionInfo || el === elements.send) el.classList.remove('active');
  });

  if (step === 'phone') {
    elements.phone.input.classList.add('active');
    elements.phone.btn.classList.add('active');
    elements.phone.label.classList.add('active');
    elements.phone.input.focus();
  } else if (step === 'amount') {
    elements.amount.input.classList.add('active');
    elements.amount.btn.classList.add('active');
    elements.amount.label.classList.add('active');
    elements.amount.input.focus();
  } else if (step === 'name') {
    elements.name.input.classList.add('active');
    elements.name.btn.classList.add('active');
    elements.name.label.classList.add('active');
    elements.name.input.focus();
  } else if (step === 'options') {
    elements.optionInfo.classList.add('active');
    elements.send.classList.add('active');
  }
}

function resetForm() {
  showStep('phone');
  elements.phone.input.value = '';
  elements.amount.input.value = '';
  elements.name.input.value = '';
}

showStep('phone');

/* ================= EVENT LISTENERS ================= */
elements.phone.btn.addEventListener("click", async () => {
  const phone = elements.phone.input.value.trim();
  if (!phone) return showStatus("Please enter phone number", true);

  try {
    const res = await fetch(`${API}/lookup/${phone}`);
    const data = await res.json();
    if (data.found) elements.name.input.value = data.name || "";
  } catch(e) {
    console.log("Lookup failed:", e);
  }
  showStep('amount');
});

elements.amount.btn.addEventListener("click", () => {
  const amount = parseFloat(elements.amount.input.value);
  if (!amount || amount <= 0) return showStatus("Please enter valid amount", true);
  showStep('name');
});

elements.name.btn.addEventListener("click", () => {
  if (!elements.name.input.value.trim()) return showStatus("Please enter full name", true);
  showStep('options');
});

elements.send.addEventListener("click", async () => {
  const phone  = elements.phone.input.value.trim();
  const amount = parseFloat(elements.amount.input.value);
  const name   = elements.name.input.value.trim();

  if (!phone || !amount || amount <= 0 || !name) {
    return showStatus("Complete all fields", true);
  }

  const cost     = calculateCost(amount);
  const token    = generateUAToken();
  const balance  = randomBalance();
  const datetime = formatDateTime();

  let message = `${token} Confirmed. Ksh${amount.toFixed(2)} sent to ${name} `
              + `on ${datetime}. New Mpesa balance is Ksh${balance}. `
              + `Transaction cost, Ksh${cost.toFixed(2)}. `
              + `Amount you can transact within the day is 499,960.00. `
              + `Sign up for Lipa Na M-PESA Till online https://m-pesaforbusiness.co.ke`;

  const payload = { phone, name, amount, cost, message, token };

  try {
    const res = await fetch(`${API}/send`, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if (data.error) return showStatus(data.error, true);

    showStatus(message);
    resetForm();
  } catch(e) {
    showStatus("Send failed", true);
  }
});
</script>
</body>
</html>
